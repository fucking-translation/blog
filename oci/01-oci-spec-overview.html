<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>OCI 规范概述 - Blog Translation</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../theme/ferris.css">
        
        <link rel="stylesheet" href="../theme/2018-edition.css">
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../lang/rust/summary.html"><strong aria-hidden="true">1.</strong> Rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/rust/01-用Rust学习解析器组合器.html"><strong aria-hidden="true">1.1.</strong> 用 Rust 学习解析器组合器</a></li><li class="chapter-item expanded "><a href="../lang/rust/02-用Rust编写LLVM的玩具前端.html"><strong aria-hidden="true">1.2.</strong> 用 Rust 编写 LLVM 的玩具前端</a></li><li class="chapter-item expanded "><a href="../lang/rust/03-使用nom解析url.html"><strong aria-hidden="true">1.3.</strong> 使用 nom 解析 url</a></li><li class="chapter-item expanded "><a href="../lang/rust/04-Rust中异步编程实用介绍.html"><strong aria-hidden="true">1.4.</strong> Rust 中异步编程实用介绍</a></li><li class="chapter-item expanded "><a href="../lang/rust/05-tokio内幕-自底向上理解Rust的异步IO框架.html"><strong aria-hidden="true">1.5.</strong> tokio 内幕-自底向上理解 Rust 的异步 IO 框架</a></li><li class="chapter-item expanded "><a href="../lang/rust/06-Rust中的Arenas.html"><strong aria-hidden="true">1.6.</strong> 「转」Rust 中的 Arenas</a></li><li class="chapter-item expanded "><a href="../lang/rust/07-Rust异步IO:从mio到coroutine.html"><strong aria-hidden="true">1.7.</strong> 「转」Rust 异步 IO: 从 mio 到 coroutine</a></li><li class="chapter-item expanded "><a href="../lang/rust/08-图解Rust所有权与生命周期.html"><strong aria-hidden="true">1.8.</strong> 「转」图解 Rust 所有权与生命周期</a></li><li class="chapter-item expanded "><a href="../lang/rust/09-Rust异步执行器.html"><strong aria-hidden="true">1.9.</strong> Rust 异步执行器</a></li><li class="chapter-item expanded "><a href="../lang/rust/10-Rust标准库特征指南.html"><strong aria-hidden="true">1.10.</strong> 「转」Rust 标准库特征指南</a></li><li class="chapter-item expanded "><a href="../lang/rust/11-Rust中的宏:带有示例的教程.html"><strong aria-hidden="true">1.11.</strong> Rust中的宏: 带有示例的教程</a></li><li class="chapter-item expanded "><a href="../lang/rust/12-libp2p教程:使用Rust构建p2p应用.html"><strong aria-hidden="true">1.12.</strong> libp2p 教程: 使用 Rust 构建 p2p 应用</a></li><li class="chapter-item expanded "><a href="../lang/rust/13-Rust的Pin与Unpin.html"><strong aria-hidden="true">1.13.</strong> 「转」Rust 的 Pin 与 Unpin</a></li><li class="chapter-item expanded "><a href="../lang/rust/14-使用GDB调试Rust应用.html"><strong aria-hidden="true">1.14.</strong> 使用 GDB 调试 Rust 中的应用</a></li><li class="chapter-item expanded "><a href="../lang/rust/15-解释Rust中的原子性.html"><strong aria-hidden="true">1.15.</strong> 解释 Rust 中的原子性</a></li><li class="chapter-item expanded "><a href="../lang/rust/16-Rust和TUI:在Rust中构建命令行界面.html"><strong aria-hidden="true">1.16.</strong> Rust 和 TUI：在 Rust 中构建命令行界面</a></li><li class="chapter-item expanded "><a href="../lang/rust/17-在Android中运行Rust.html"><strong aria-hidden="true">1.17.</strong> 在 Android 中运行 Rust</a></li><li class="chapter-item expanded "><a href="../lang/rust/18-Rust中常见的有关生命周期的误解.html"><strong aria-hidden="true">1.18.</strong> 「转」Rust 中常见的有关生命周期的误解</a></li><li class="chapter-item expanded "><a href="../lang/rust/19-生命周期型变示例.html"><strong aria-hidden="true">1.19.</strong> 生命周期型变示例</a></li><li class="chapter-item expanded "><a href="../lang/rust/std/20-std-pin.html"><strong aria-hidden="true">1.20.</strong> 标准库</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../lang/rust/std/20-std-pin.html"><strong aria-hidden="true">1.20.1.</strong> std::pin</a></li><li class="chapter-item expanded "><a href="../lang/rust/std/21-std-condvar.html"><strong aria-hidden="true">1.20.2.</strong> std::sync::Condvar</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../架构/ServiceMesh/summary.html"><strong aria-hidden="true">2.</strong> Service Mesh</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../架构/ServiceMesh/01-ServiceMesh.html"><strong aria-hidden="true">2.1.</strong> 模式：Service Mesh</a></li><li class="chapter-item expanded "><a href="../架构/ServiceMesh/02-xDS与gRPC协议.html"><strong aria-hidden="true">2.2.</strong> xDS 与 gRPC 协议</a></li></ol></li><li class="chapter-item expanded "><a href="../oci/summary.html"><strong aria-hidden="true">3.</strong> Open Container Initiative</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../oci/01-oci-spec-overview.html" class="active"><strong aria-hidden="true">3.1.</strong> OCI 规范概述</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Blog Translation</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/fucking-translation/blog" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="开放容器倡议-oci-规范概述"><a class="header" href="#开放容器倡议-oci-规范概述">开放容器倡议 (OCI) 规范概述</a></h1>
<p><a href="https://alibaba-cloud.medium.com/open-container-initiative-oci-specifications-375b96658f55">原文</a></p>
<p>OCI (Open Container Initiative) 是一个由行业合作提出的倡议，旨在定义有关容器镜像格式与运行时的开放<a href="https://www.alibabacloud.com/product/container-service">容器</a>规范。就开源世界的合作与竞争而言，从最初的分歧到如何一步步到达今天地位上的历史是一个非常有趣的故事。</p>
<p>如今，容器生态系统的所有主要玩家都遵循 OCI 容器规范。对于任何想要了解容器工作原理的同学，这是一门你绝不想错过的技术。</p>
<h2 id="概览"><a class="header" href="#概览">概览</a></h2>
<p>OCI 有两项规范，<a href="https://github.com/opencontainers/image-spec">Image spec</a> 和 <a href="https://github.com/opencontainers/runtime-spec">Runtime spec</a>。</p>
<p>下图显示了它们涵盖的内容和交互的方式。</p>
<p><img src="./img/oci1.png" alt="oci1" /></p>
<p>OCI 镜像可以从其他地方下载(如 Docker Hub) 并在 OCI 运行时文件系统包中解压。然后 OCI 运行时包将会运行在 OCI 运行时中。其中，OCI 运行时规范定义了如何运行一个”文件系统包“。</p>
<h2 id="镜像规范-image-spec"><a class="header" href="#镜像规范-image-spec">镜像规范 (image-spec)</a></h2>
<p>镜像规范定义了 OCI 容器镜像的格式，其中包含 manifest，镜像索引 (image index)，一组文件系统层以及一个配置文件。这个规范的目标是创建互操作工具，用于构建，传输，以及准备要运行的容器镜像。</p>
<p>在顶层视角，容器镜像只是个 tarball 压缩包，在解压之后，它拥有以下<code>布局</code>。</p>
<pre><code class="language-console">├── blobs
│   └── sha256
│       ├── 4297f0*      (image.manifest)
│       └── 7ea049       (image.config)
├── index.json
└── oci-layout
</code></pre>
<p>如果没有说明这些东西都是些什么以及它们是如何关联的，该布局就没那么有用。</p>
<p>我们可以简单的忽略<code>oci-layout</code>文件。<code>index.json</code>是入口点，它包含了主要的<code>manifest</code>，其中列出了所有用于单个容器镜像的”资源“。</p>
<p><code>manifest</code>包含主要的<code>config</code>和<code>layers</code>。</p>
<p>将它使用图表表示：</p>
<p><img src="./img/oci2.png" alt="oci2" /></p>
<p><a href="https://github.com/opencontainers/image-spec/blob/master/config.md">配置 (config)</a> 包含：</p>
<ul>
<li>镜像的配置，它将会转换成 OCI 运行时包的运行时配置文件。</li>
<li>layers，构成 OCI 运行时包的根文件系统</li>
<li>一些与镜像历史相关的元数据</li>
</ul>
<p><a href="https://github.com/opencontainers/image-spec/blob/master/layer.md">层级 (layers)</a> 构成最终的<code>rootfs</code>。第一层级是基础，其他所有层级仅包含第一次层级的变更。在下一节中我们深入研究一下什么是 OCI 层级规范。</p>
<h2 id="层级"><a class="header" href="#层级">层级</a></h2>
<p>规范中本质上关于层级定义了以下两点：</p>
<ol>
<li>如何表示一个层级</li>
</ol>
<ul>
<li>对于基础层级， 压缩所有的内容</li>
<li>对于非基础层级，压缩所有与其主层级比较后变更内容的集合</li>
<li>因此，首先检测变更，形成一个<code>changeset</code>；然后压缩此变更集合以表示该层级</li>
</ul>
<ol start="2">
<li>如何联合所有层级</li>
</ol>
<p>在主层级的顶层应用所有的变更集合。将会给你带来<code>rootfs</code>。</p>
<h2 id="运行时规范-runtime-spec"><a class="header" href="#运行时规范-runtime-spec">运行时规范 (runtime-spec)</a></h2>
<p>一旦在磁盘文件系统中将镜像解压到 OCI 运行时包中，你可以将其运行起来。此时是 OCI 运行时规范在起作用。该规范指定了容器的配置，执行环境以及生命周期。</p>
<p>容器配置包含必要的元数据用来创建及运行此容器。其中包含要使用的运行线程，环境变量，资源限制以及沙盒功能等。一些配置与平台无关，可用于 Linux，Windows，Solaris 以及特定的虚拟机；但另一些配置与平台相关，可能仅适用于 Linux。</p>
<p>OCI 运行时规范还定义了容器的生命周期，这是一系列从容器创建到停止时发生的事件。</p>
<h2 id="容器生命周期"><a class="header" href="#容器生命周期">容器生命周期</a></h2>
<p>容器拥有生命周期，从本质上讲，它可以用以下状态图建模。</p>
<p>你可以添加一些其他的动作和状态，如<code>pause</code>和<code>paused</code>，但是这些都是最oci基础的。</p>
<p><img src="./img/oci3.png" alt="oci3" /></p>
<p>此状态图比较常规，但是这里有一个重要的事情需要提及一下 - <code>Hooks</code>。你可能有些惊讶，容器规范并没有定义如何设置网络，它实际上依赖 hook 来正确的设置网络，比如在容器启动之前创建网络并在容器停止之后删除它。</p>
<h2 id="容器配置"><a class="header" href="#容器配置">容器配置</a></h2>
<p>我们之前提过容器的配置包含创建和运行容器的必要配置，我们将更仔细地查看一些配置，以了解容器的真正含义，并且我们将专注于 Linux 平台上的所有配置。</p>
<ol>
<li>
<p>Root</p>
<p>它定义了容器的根文件系统。</p>
</li>
<li>
<p>Mounts</p>
<p>它指定了可以挂在到根文件系统上的附加文件系统。你在使用它挂载本地路径或者分布式路径(如 Ceph)。</p>
</li>
<li>
<p>Process</p>
<p>它指定了与你要在容器中运行的进程相关的所有内容。包括环境变量和进程参数。</p>
</li>
</ol>
<p>对于 Linux 进程，你可以额外指定有关进程安全方面的内容，如 capabilities，rlimits 以及 selinux 标签。</p>
<ol>
<li>
<p>Hooks</p>
<p>你可以在此处连接到容器的生命周期，并执行网络设置与清理操作。</p>
</li>
<li>
<p>Linux 命名空间</p>
</li>
</ol>
<p>Linux 平台的大量配置专用于命名空间配置。实际上，命名空间是容器技术的基础。换句话说，没有命名空间就没有容器。Linux 提供了 7 种命名空间，它们都得到了 OCI 运行时规范的支持。</p>
<table><thead><tr><th>名称</th><th>宏定义</th><th>隔离的资源</th></tr></thead><tbody>
<tr><td>IPC</td><td>CLONE_NEWIPC</td><td>System V IPC (信号量，消息队列和共享内存)，POSIX message queues</td></tr>
<tr><td>Network</td><td>CLONE_NEWNET</td><td>Network devices，stacks，ports (网络设备，网络栈，端口等)</td></tr>
<tr><td>Mount</td><td>CLONE_NEWNS</td><td>Mount points (文件系统挂载点)</td></tr>
<tr><td>PID</td><td>CLONE_NEWPID</td><td>Process IDs (进程编号)</td></tr>
<tr><td>User</td><td>CLONE_NEWUSER</td><td>User and group IDs (用户和用户组)</td></tr>
<tr><td>UTS</td><td>CLONE_NEWUTS</td><td>Hostname and NIS domain name (主机名与 NIS 域名)</td></tr>
<tr><td>Cgroup</td><td>CLONE_NEWCGROUP</td><td>Cgroup root directory (cgroup 的根目录)</td></tr>
</tbody></table>
<ol start="3">
<li>注释</li>
</ol>
<p>除了容器应该运行的内容和方式之外，还可以通过注释标记容器。基于某些属性标记和选择容器的能力是容器编排 (orchestration) 平台的基本要求。</p>
<h2 id="镜像容器和进程"><a class="header" href="#镜像容器和进程">镜像，容器和进程</a></h2>
<p>容器通过(容器)镜像创建。你可以通过一个镜像创建多个容器，还可以重新打包容器(这些容器通常带有一些基础容器的变更内容)以创建新的镜像。</p>
<p>在你获取容器之后，你可以在容器内部运行进程，而无需容器的所有优点。最值得注意的是，一旦我们容器化一个应用程序，它就会称为自包含的，不会与宿主环境混淆，因此它可以”run everwhere“。</p>
<p>以下是各种概念，镜像，容器和进程之间的关系，将它们理清楚是至关重要的。</p>
<p><img src="./img/oci4.png" alt="oci4" /></p>
<h2 id="docker-和-kubernetes"><a class="header" href="#docker-和-kubernetes">Docker 和 Kubernetes</a></h2>
<p>Docker 使容器称为行业趋势，很多人认为 Docker 是容器，容器是 Docker。Docker 在这里绝对值得称赞，但从技术角度来看，Docker 是应用最广泛的容器实现。Docker 实现的架构从一个版本到另一个版本的演变非常快。在撰写本文时，它如下所示：</p>
<p><img src="./img/oci5.png" alt="oci5" /></p>
<p>该图遵循<code>github]Org/project</code>的格式。大多数组件源自 Docker，但目前在不同的 Github 组织和项目下。最上面使我们日常使用的 Docker 命令工具，它是 Docker Inc. 的商业产品；Docker 工具以来于一个名为 moby 的开源项目，该项目又使用了 runc，它是 oci 运行时规范的参考实现。runc 严重以来 libcontainer，它也是 Docker Inc. 捐赠的。</p>
<h2 id="容器编排"><a class="header" href="#容器编排">容器编排</a></h2>
<p>如果我们只需要 1 到 2 个容器，Docker 可能就够了。但是如果我们要运行成千上万的容器，我们就有很多的问题需要解决。仅举几例：</p>
<ol>
<li>调度：容器放在哪个主机上？</li>
<li>更新：如何更新容器镜像？</li>
<li>伸缩性：当需要扩容时如何添加更多的容器？</li>
</ol>
<p>这是容器编排系统的工作。Kubernetes 是其中之一，但是截至目前，我认为它是最有前途。这里我们不会深入研究 Kubernetes，而是从容器运行时如何适应容器编排平台的角度简要介绍一下。</p>
<p>下图中展示了 Kubernetes 是如何与容器运行时进行交互的。</p>
<p><img src="./img/oci6.png" alt="oci6" /></p>
<p>Kubernetes 使用容器运行时接口对运行时实现进行解耦。简单来说，CRI 定义了创建，启动，停止和删除容器的接口。它允许 Kubernetes 使用可插拔式容器运行时，你不必锁定到某一个特定的运行时。目前有几种实现方式，如<code>cri-containerd</code>和<code>cri-o</code>，两者最终都会使用<code>oci/runc</code>。</p>
<h2 id="总结"><a class="header" href="#总结">总结</a></h2>
<p>本文是对 OCI 运行时镜像和运行时规范的概述。它涵盖了每个规范的责任以及它们如何相互协作，我们回顾了容器生命周期和运行时规范的主要配置。然后介绍了 Docker 和<code>runc</code>的关系，并简要介绍了容器编排以及容器运行时是如何融入其中的。</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../oci/summary.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../oci/summary.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../theme/ferris.js"></script>
        

        

    </body>
</html>
